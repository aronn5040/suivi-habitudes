<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Recettes avec mon frigo</title>
<style>
body { font-family: Arial; background:#f2f4f7; padding:20px; }
.container { max-width:800px; margin:auto; background:white; padding:20px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.1); }
h1{text-align:center;}
input,button{display:block;margin:15px auto;}
button{padding:12px 20px;border-radius:8px;border:none;background:#27ae60;color:white;font-size:16px;cursor:pointer;}
button:hover{background:#219150;}
#preview{display:block;max-width:300px;margin:15px auto;border-radius:10px;}
.recipe{background:#fafafa;padding:10px;border-radius:8px;margin-bottom:10px;border-left:6px solid #27ae60;}
.loader{text-align:center;font-weight:bold;color:#555;}
</style>
</head>
<body>
<div class="container">
  <h1>üì∏ Recettes avec les ingr√©dients de ton frigo</h1>
  <input type="file" id="imageInput" accept="image/*"/>
  <img id="preview"/>
  <button id="analyzeBtn">Analyser et trouver des recettes</button>

  <h2>ü•ï Ingr√©dients d√©tect√©s</h2>
  <ul id="ingredientsList"></ul>

  <h2>üçΩÔ∏è Recettes propos√©es</h2>
  <div id="recipes"></div>

  <div class="loader" id="loader"></div>
</div>

<script>
const imageInput = document.getElementById("imageInput");
const preview = document.getElementById("preview");
const analyzeBtn = document.getElementById("analyzeBtn");
const ingredientsList = document.getElementById("ingredientsList");
const recipesDiv = document.getElementById("recipes");
const loader = document.getElementById("loader");

imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (file) preview.src = URL.createObjectURL(file);
});

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
  });
}

function displayIngredients(ingredients) {
  ingredientsList.innerHTML = "";
  ingredients.forEach(i => {
    const li = document.createElement("li");
    li.textContent = i;
    ingredientsList.appendChild(li);
  });
}

function displayRecipes(recipes) {
  recipesDiv.innerHTML = "";
  recipes.forEach(r => {
    const div = document.createElement("div");
    div.className = "recipe";
    div.innerHTML = `
      <h3>${r.title}</h3>
      <img src="${r.image}" width="100%">
      <p>Ingr√©dients utilis√©s : ${r.usedIngredientCount}</p>
      <p>Ingr√©dients manquants : ${r.missedIngredientCount}</p>
    `;
    recipesDiv.appendChild(div);
  });
}

analyzeBtn.addEventListener("click", async () => {
  if (!imageInput.files[0]) return alert("Ajoute une photo !");
  loader.textContent = "Analyse de l'image...";
  recipesDiv.innerHTML = "";
  ingredientsList.innerHTML = "";

  try {
    const base64 = await toBase64(imageInput.files[0]);

    const detectRes = await fetch("/detect-ingredients", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: base64 })
    });
    const { ingredients } = await detectRes.json();
    displayIngredients(ingredients);

    loader.textContent = "Recherche de recettes...";
    const recipeRes = await fetch("/get-recipes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ingredients })
    });
    const recipes = await recipeRes.json();
    displayRecipes(recipes);

    loader.textContent = "";
  } catch (err) {
    console.error(err);
    loader.textContent = "Erreur.";
  }
});
</script>
</body>
</html>
